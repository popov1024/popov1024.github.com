<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>1С:Предприятие &#43; Ant &#43; jenkins &middot; Andrey Popov</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://popov.by/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://popov.by/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://popov.by/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  

  <link rel="shortcut icon" href="https://popov.byimg/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/andrey_popov" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="*" target="_blank"><i class="fa fa-comment fa-fw"></i>GNU social</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/*" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://plus.google.com/+*" target="_blank"><i class="fa fa-google-plus-square fa-fw"></i>Google+</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://weibo.com/*" target="_blank"><i class="fa fa-weibo fa-fw"></i>Weibo</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://*.tumblr.com/" target="_blank"><i class="fa fa-tumblr-square fa-fw"></i>Tumblr</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>1С:Предприятие &#43; Ant &#43; jenkins</h1>
  <h2></h2>
</div>
<div class="content">
  <p>1С:Предприятие обладает очень скудными средствами разработки и интеграции. Однако выжать максимум автоматизации сборки и публикации можно.
Мои проекты имеют следующий жизненный цикл:</p>

<ol>
<li>Внесение изменений в код согласно Jira</li>
<li>Выпуск тестовой сборки</li>
<li>Исправление ошибок по необходимости</li>
<li>Выпуск релиза (проверка конфигурации, формирование cf + cfu, формирование отчета по измененным объектам хранилища конфигурации)</li>
<li>Изменение версии в хранилище конфигурации</li>
</ol>

<p>Для выпуска релиза мной разработан build.xml для Apache Ant</p>

<pre><code>&lt;project name=&quot;kisnpo&quot; default=&quot;build&quot;&gt;
	&lt;description&gt;kisnpo build&lt;/description&gt;
	&lt;property environment=&quot;env&quot;/&gt;
	&lt;property name=&quot;rep&quot; value=&quot;tcp://share\myproject\&quot;/&gt;
	&lt;property name=&quot;replogin&quot; value=&quot;login&quot;/&gt;
	&lt;property name=&quot;reppassword&quot; value=&quot;password&quot;/&gt;
	&lt;property name=&quot;ibname&quot; value=&quot;c:\ib\myproject&quot;/&gt;
	&lt;property name=&quot;ib&quot; value=&quot;/F${ibname}&quot;/&gt;
	&lt;property name=&quot;iblogin&quot; value=&quot;login&quot;/&gt;
	&lt;property name=&quot;ibpassword&quot; value=&quot;password&quot;/&gt;
	&lt;property name=&quot;connectionstring&quot; value=&quot;Usr=&quot;${iblogin}&quot;;Pwd=&quot;${ibpassword}&quot;;File=&quot;${ibname}&quot;;&quot;/&gt;
	&lt;property name=&quot;1cbin&quot; location=&quot;C:\Program Files (x86)\1cv81\bin\1cv8.exe&quot;/&gt;
	&lt;property name=&quot;1cbincom&quot; value=&quot;V81.COMConnector&quot;/&gt;
	&lt;property name=&quot;builds&quot; location=&quot;${env.WORKSPACE}&quot;/&gt;
	&lt;property name=&quot;publishdebug&quot; location=&quot;\\ftp\project-test&quot;/&gt;
	&lt;property name=&quot;publish&quot; location=&quot;\\ftp\project&quot;/&gt;
	&lt;property name=&quot;NBegin&quot; value=&quot;1&quot;/&gt;
	&lt;property name=&quot;NEnd&quot; value=&quot;1&quot;/&gt;
	&lt;target name=&quot;init&quot; depends=&quot;build-version&quot;&gt;
		&lt;fail if=&quot;version_present&quot; message=&quot;Version ${version} is builed&quot;/&gt;
		&lt;echo message=&quot;ok&quot;/&gt;
	&lt;/target&gt;
	&lt;target name=&quot;build-version&quot; unless=&quot;version&quot;&gt;
		&lt;exec executable=&quot;powershell.exe&quot; output=&quot;.version&quot; failonerror=&quot;true&quot;&gt;
			&lt;arg value=&quot;$c=new-object -comobject \&quot;${1cbincom}\&quot;;&quot;/&gt;
			&lt;arg value=&quot;$b=$c.Connect(\&quot;${connectionstring}\&quot;);&quot;/&gt;
			&lt;arg value=&quot;$medata=[System.__ComObject].invokemember(\&quot;Metadata\&quot;,[System.Reflection.BindingFlags]::GetProperty,$null,$b,$null);&quot;/&gt;
			&lt;arg value=&quot;[String]$buildversion = [System.__ComObject].invokemember(\&quot;Version\&quot;,[System.Reflection.BindingFlags]::GetProperty,$null,$medata ,$null);&quot;/&gt;
			&lt;arg value=&quot;echo $buildversion;&quot;/&gt;
			&lt;arg value=&quot;$rb=[System.Runtime.Interopservices.Marshal]::ReleaseComObject($b);&quot;/&gt;
			&lt;arg value=&quot;$rc=[System.Runtime.Interopservices.Marshal]::ReleaseComObject($c)&quot;/&gt;
		&lt;/exec&gt;
		&lt;loadfile property=&quot;version&quot; srcFile=&quot;.version&quot;&gt;
		&lt;filterchain&gt;
			&lt;striplinebreaks/&gt;
		&lt;/filterchain&gt;
		&lt;/loadfile&gt;
		&lt;available filepath=&quot;${builds}&quot; file=&quot;${version}&quot; type=&quot;dir&quot; property=&quot;version_present&quot;/&gt;
		&lt;echo message=&quot;ok&quot;/&gt;
	&lt;/target&gt;
	&lt;target name=&quot;clean&quot;&gt;
		&lt;delete file=&quot;.version&quot;/&gt;
		&lt;delete file=&quot;.checkerror&quot;/&gt;
		&lt;delete file=&quot;.updatescf&quot;/&gt;
		&lt;delete file=&quot;.resultcheck&quot;/&gt;
		&lt;delete file=&quot;.report&quot;/&gt;
		&lt;echo message=&quot;ok&quot;/&gt;
	&lt;/target&gt;
	&lt;target name=&quot;update&quot;&gt;
		&lt;exec executable=&quot;${1cbin}&quot; failonerror=&quot;true&quot;&gt;
			&lt;arg value=&quot;CONFIG&quot;/&gt;
			&lt;arg value=&quot;${ib}&quot;/&gt;
			&lt;arg value=&quot;/N${iblogin}&quot;/&gt;
			&lt;arg value=&quot;/P${ibpassword}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryF${rep}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryN${replogin}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryP${reppassword}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryUpdateCfg&quot;/&gt;
			&lt;arg value=&quot;-force /UpdateDBCfg&quot;/&gt;
		&lt;/exec&gt;
		&lt;echo message=&quot;ok&quot;/&gt;
	&lt;/target&gt;
	&lt;target name=&quot;check&quot; depends=&quot;update&quot;&gt;
		&lt;exec executable=&quot;${1cbin}&quot; output=&quot;.resultcheck&quot; failonerror=&quot;true&quot;&gt;
			&lt;arg value=&quot;CONFIG&quot;/&gt;
			&lt;arg value=&quot;${ib}&quot;/&gt;
			&lt;arg value=&quot;/N${iblogin}&quot;/&gt;
			&lt;arg value=&quot;/P${ibpassword}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryF${rep}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryN${replogin}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryP${reppassword}&quot;/&gt;
			&lt;arg value=&quot;/CheckConfig&quot;/&gt;
			&lt;arg value=&quot;-IncorrectReferences&quot;/&gt;
			&lt;arg value=&quot;-Client&quot;/&gt;
			&lt;arg value=&quot;-ClientServer&quot;/&gt;
			&lt;arg value=&quot;-ExternalConnectionServer&quot;/&gt;
			&lt;arg value=&quot;-ExternalConnection&quot;/&gt;
			&lt;arg value=&quot;-Server&quot;/&gt;
			&lt;arg value=&quot;-DistributiveModules&quot;/&gt;
			&lt;arg value=&quot;-ConfigLogicalIntegrity&quot;/&gt;
			&lt;arg value=&quot;/DumpResult .checkerror&quot;/&gt;
		&lt;/exec&gt;
		&lt;loadfile property=&quot;checkerror&quot; srcFile=&quot;.checkerror&quot; encoding=&quot;utf-8&quot;&gt;
			&lt;filterchain&gt;
				&lt;tokenfilter&gt;
					&lt;containsregex pattern=&quot;^[^0-9\-]+(0)$&quot;/&gt;
				&lt;/tokenfilter&gt;
			&lt;/filterchain&gt;
		&lt;/loadfile&gt;
		&lt;fail unless=&quot;checkerror&quot;/&gt;
		&lt;echo message=&quot;ok&quot;/&gt;
	&lt;/target&gt;
	&lt;target name=&quot;build&quot; depends=&quot;check,init&quot; unless=&quot;version_present&quot;&gt;
		&lt;exec executable=&quot;cmd.exe&quot;&gt;
			&lt;arg value=&quot;/c&quot;/&gt;
			&lt;arg value=&quot;rd&quot;/&gt;
			&lt;arg value=&quot;.last&quot;/&gt;
		&lt;/exec&gt;
		&lt;echo message=&quot;Build version is ${version}&quot;/&gt;
		&lt;exec executable=&quot;powershell.exe&quot; output=&quot;.updatescf&quot; failonerror=&quot;true&quot;&gt;
			&lt;arg value=&quot;[String]$p=\&quot;\&quot;;&quot;/&gt;
			&lt;arg value=&quot;ls ${builds}\* -Include 1cv8.cf -Recurse | split-path -parent | split-path -leaf | foreach {$p = $p + \&quot; -f $_\1cv8.cf -v $_ \&quot;};&quot;/&gt;
			&lt;arg value=&quot;echo $p&quot;/&gt;
		&lt;/exec&gt;
		&lt;loadfile property=&quot;updatescf&quot; srcFile=&quot;.updatescf&quot;&gt;
			&lt;filterchain&gt;
				&lt;striplinebreaks/&gt;
			&lt;/filterchain&gt;
		&lt;/loadfile&gt;
		&lt;exec executable=&quot;${1cbin}&quot; output=&quot;.resultcheck&quot; failonerror=&quot;true&quot;&gt;
			&lt;arg value=&quot;CONFIG&quot;/&gt;
			&lt;arg value=&quot;${ib}&quot;/&gt;
			&lt;arg value=&quot;/N${iblogin}&quot;/&gt;
			&lt;arg value=&quot;/P${ibpassword}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryF${rep}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryN${replogin}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryP${reppassword}&quot;/&gt;
			&lt;arg value=&quot;/CreateDistributionFiles -cffile ${version}\1cv8.cf -cfufile ${version}\1cv8.cfu&quot;/&gt;
			&lt;arg value=&quot;${updatessubcf}&quot;/&gt;
			&lt;arg value=&quot;${updatescf}&quot;/&gt;
		&lt;/exec&gt;
		&lt;sleep seconds=&quot;30&quot;/&gt;
		&lt;exec executable=&quot;cmd.exe&quot;&gt;
			&lt;arg value=&quot;/c&quot;/&gt;
			&lt;arg value=&quot;mklink&quot;/&gt;
			&lt;arg value=&quot;/J&quot;/&gt;
			&lt;arg value=&quot;.last&quot;/&gt;
			&lt;arg value=&quot;${version}&quot;/&gt;
		&lt;/exec&gt;
		&lt;echo message=&quot;ok&quot;/&gt;
	&lt;/target&gt;
	&lt;target name=&quot;publishdebug&quot; depends=&quot;build-version&quot; if=&quot;${publishdebugenable}&quot;&gt;
		&lt;copy todir=&quot;${publishdebug}/${version}&quot;&gt;
			&lt;fileset dir=&quot;${builds}/${version}&quot;/&gt;
		&lt;/copy&gt;
		&lt;echo message=&quot;ok&quot;/&gt;
	&lt;/target&gt;
	&lt;target name=&quot;publish&quot; depends=&quot;build-version&quot; if=&quot;${publishenable}&quot;&gt;
		&lt;copy todir=&quot;${publish}/${version}&quot;&gt;
			&lt;fileset dir=&quot;${builds}/${version}&quot;/&gt;
		&lt;/copy&gt;
		&lt;echo message=&quot;ok&quot;/&gt;
	&lt;/target&gt;
	&lt;target name=&quot;report&quot;&gt;
		&lt;exec executable=&quot;${1cbin}&quot;&gt;
			&lt;arg value=&quot;CONFIG&quot;/&gt;
			&lt;arg value=&quot;${ib}&quot;/&gt;
			&lt;arg value=&quot;/N${iblogin}&quot;/&gt;
			&lt;arg value=&quot;/P${ibpassword}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryF${rep}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryN${replogin}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryP${reppassword}&quot;/&gt;
			&lt;arg value=&quot;/ConfigurationRepositoryReport ${version}/.report -NBegin ${NBegin} -NEnd ${NEnd} -GroupByObject -GroupByComment&quot;/&gt;
		&lt;/exec&gt;
		&lt;sleep seconds=&quot;30&quot;/&gt;
	&lt;/target&gt;
&lt;/project&gt;
</code></pre>

<p>Данный build.xml подразумевает следующую структуру каталогов:</p>

<pre><code>&lt;Builds&gt;
    [Project name]
        [.last]      - ссылка на последнюю мажорную версию
        [Version 1]
        [Version 2]
        ...
        [Version n]
        	[.last]  - ссылка на последнюю минорную версию
        	[Buld 1]
        	[Buld 2]
        	...
        	[Buld m]
</code></pre>

<p>Например:</p>

<pre><code>MyProject
	[.last]
	[1.0.1]
		[.last]
		[1.0.1.1]
		[1.0.1.2]
		[1.0.1.3]
		[1.0.1.4]
	[1.0.2]
		[.last]
		[1.0.1.4] - ссылка на предыдущую последнюю (релизную) мажорную сборку
		[1.0.2.1]
		[1.0.2.2]
</code></pre>

<p>Для каждой мажорной версии в jenkins создается своя задача. CI-системы Bamboo или Team City позволяют добиться более удобного представления проектов, но пока мне хватает простоты и бесплатности Jenkins&rsquo;а.</p>

<p>Переключение версии никакими стандартными средствами 1С не предусмотрено, так же никак нельзя автоматизированно узнать номера изменений хранилища конфигурации для построения отчета по измененным объектам.</p>

<p>В чем плюсы такой связки? Во-первых, это упрощает и автоматизирует типовые этапы жизненного цикла проектов. Да - можно было написать все просто скриптами (как и было до этого), но в конечном счете этот путь приведет к написанию чего-нибудь наподобие Apache Ant, когда нужно на этапе выполнения определить зависимость целей и все необходимые параметры. Во-вторых, используя Apache Ant мы обеспечиваем возможность работы с различными современными CI.</p>

</div>

</div>
</div>
<script src="https://popov.byjs/ui.js"></script>




</body>
</html>

